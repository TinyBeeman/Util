<!DOCTYPE html>
<head>
	<title>Prompt Style Generator</title>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
	<style>
		textarea { resize: none; }
		.txtbox{ width: 100%; }

		ui-widget input, .ui-widget select, .ui-widget textarea, .ui-widget button {
			font-size: 0.75em !important;
			font-weight:normal !important;
		}

		.in_out_container {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			grid-template-rows: repeat(2, auto);
		}

		.in_container {
			grid-column: 1;
			grid-row: 1;
		}

		.out_container {
			grid-column: 2;
			grid-row: 1;
		}

		.process_container {
			grid-row: 2;
			grid-column: 1;
			grid-column-end: 3;
			
			display: grid;
		}

		.options_container {
			grid-row: 1;
			display: flex;
			flex-direction: column;
		}

		.row {
			display: flex;
			flex-direction: row;
			align-items: center;
			gap: 6px;
		}

		.list_edit_container {
			display: grid;
			grid-template-columns: 1fr 3fr;
			column-gap: 6px;
		}

		.list_container {
			display: flex;
			flex-direction: column;
			gap: 6px;
			grid-column: 1;
		}

		.item_container {
			grid-column: 2;

			display: flex;
			flex-direction: column;
		}

		.success {
			color: green;
		}

		.error {
			color: red;
		}

		.prop_row {
			display: grid;
			grid-template-columns: 10em 1fr;
			grid-column-gap: 6px;
		}

		.prop_row label {
			grid-column: 1;
		}

		label.changed {
			color: red;
		}

		.prop_row textarea {
			grid-column: 2;
			width: 100%;
		}

	</style>

</head>
<body>
	<div class="root">
		<div id="tabs">
			<ul class="tabs">
				<li><a href="#tab_load_json">Load Prompt Json</a></li>
				<li><a href="#tab_tools">Tools</a></li>
				<li><a href="#tab_edit">Edit Entries</a></li>
			</ul>
			<div class="tab" id="tab_load_json" data-tab-name="Json Loader">
				<div class="in_out_container">
					<div class="in_container">
						<textarea
							id="json_in"
							class="txtbox"
							rows="25"
							placeholder="list of strings"></textarea>
					</div>
					<div class="out_container">
						<textarea
							id="txt_out"
							class="txtbox"
							rows="25"
							readonly></textarea>
					</div>
					<div class="process_container">
						<div class="options_container">
							<div class="row">
								<button id="btn_load_json">Load Prompts</button>
								<p id="p_load_results"></p>
							</div>
						</div>
					</div>	
				</div>
			</div>

			<div class="tab" id="tab_tools" data-tab-name="Tools">
				<div class="in_out_container">
					<div class="in_container">
						<textarea
							id="tool_in"
							class="txtbox"
							rows="25"
							placeholder="list of strings"></textarea>
					</div>
					<div class="out_container">
						<textarea
							id="tool_out"
							class="txtbox"
							rows="25"
							readonly></textarea>
					</div>
					<div class="process_container">
						<div class="options_container">
							<div class="row">
								<button id="btn_get_styles_psv">Generate Styles PSV</button>
								<button id="btn_get_subjects_psv">Generate Subjects PSV</button>
								<button id="btn_get_subject_names">Generate Subject Names</button>
								<button id="btn_get_json">Generate Json from DB</button>
								<button id="btn_clear_tool_outout">Clear Output</button>
								<p id="p_tool_results"></p>
							</div>
							<div class="row">
								<button id="btn_filter_subject_names">Get Filtered Subject Names</button>
								<label for="txt_filter">Filter</label><textarea id="txt_filter" placeholder="filter" rows="1"></textarea>
								<input type="checkbox" name="favorites" id="cb_favorites" value="favorite"/><label for="cb_favorites">Favorites Only</label>
							</div>
							<div class="row">
								<button id="btn_random_prompts">Add Random Prompts</button>
								<label for="cb_subjects_only">Subjects Only</label><input id="cb_subjects_only" type="checkbox" />
								<label for="prompt_count">Count</label><input id="prompt_count_slider" type="range" value="10" min="0" max="1000" step="10" /><input id="prompt_count" type="number" value="10" min="1" />
								<input id="random_prompt_postfix" type="text" placeholder="Add extra prompt text here" />
							</div>
						</div>
					</div>	
				</div>
			</div>

			<div class="tab" id="tab_edit" data-tab-name="Edit Entries">
				<div class="list_edit_container">
					<div class="list_container">
						<select name="categories" id="sel_category">
							<option disable selected value>select a category</option>
							<option value="styles">styles</option>
							<option value="subjects">subjects</option>
						</select>
						<select id="sel_item" name="list_items" size="20">
							<option>Select</option>
							<option>A</option>
							<option>Category</option>
						</select>
						<button id="btn_new_entry">New Entry</button>
					</div>
					<div id="props" class="item_container">
						<div class="prop_row">
							<label for="txt_prop_1">prop 1</label><textarea id="txt_prop_1" data-prop="Prop1" rows="1">Value1</textarea>
						</div>
					</div>
					<!--<div class="process_container">
						<div class="options_container">
							<div class="row">
								<button id="btn_get_styles_psv">Generate styles PSV</button>
								<button id="btn_get_subjects_psv">Generate Subjects PSV</button>
								<p id="p_tool_results"></p>
							</div>
						</div>
					</div>-->
				</div>
			</div>
			

		</div>
	</div>
	<script>

// JAVASCRIPT UTILITY FUNCTIONS

function random_entry(rg) { return rg[Math.floor(Math.random()*rg.length)];}
function random_object_property_value(obj) { return obj[random_entry(Object.keys(obj))]; }
function random_object_key(obj) { return random_entry(Object.keys(obj)); }
function get_opv(obj, prop, default_val = "")
{
	if (Object.keys(obj).includes(prop))
		return obj[prop];
	
	return default_val;
}

function get_var_type(val)
{
	if (Array.isArray(val))
		return "array";
	else if (val.constructor == Object)
		return "dict";
	else if (typeof val === 'string')
		return "string";
	else
		return "unknown";
}


function property_compare(a, b, name_first)
{
	if (a === b)
		return 0;

	if (name_first)
	{
		if (a === "name")
			return -1;
		if (b === "name")
			return 1;
	}

	return  a.localeCompare(b);
}

function sort_obj_props(obj, name_first = false, deep=false)
{
	if (deep)
	{
		Object.keys(obj).forEach( k => {
			t = get_var_type(obj[k]);
			if (t === "array")
			{
				obj[k] = obj[k].sort();
			}
			else if (t === "dict")
			{
				obj[k] = sort_obj_props(obj[k], name_first, deep);
			}
		});
	}

	return Object.fromEntries(Object.entries(obj).sort((a, b) => property_compare(a[0], b[0], name_first)));
}

function ensure_array(val)
{
	if (Array.isArray(val))
		return val;

	if ($.type(val) === "string")
	{
		return val.split(';').map(element => element.trim());
	}

	return [ val ]
}

function sanitize_record(obj)
{
	// TODO: Use description to identify arrays and objects?
	if (Object.keys(obj).includes("tags"))
		obj["tags"] = ensure_array(obj["tags"]);
	if (Object.keys(obj).includes("ethnicity"))
		obj["ethnicity"] = ensure_array(obj["ethnicity"]);

	return sort_obj_props(obj, true /*name first*/, true /*deep*/);
}


class PromptDatabase
{
	constructor(json_obj)
	{
		this.m_source = json_obj;
	}

	get_category_records(category) { return get_opv(this.m_source, category, null);	}
	get categories() { return [ "subjects", "style_prompts", "styles" ]}
	get subjects() { return this.get_category_records("subjects"); }
	get styles() { return this.get_category_records("styles"); }
	get style_prompts() { return this.get_category_records("style_prompts")}
	get desc() { return this.m_source["_desc"]}

	get json() { return JSON.stringify(this.m_source, null, "\t");}

	generate_desc()
	{
		this.m_source["_desc"] = new Object();
		this.categories.forEach( cat => {
			this.m_source["_desc"][cat] = this.generate_cols_from_category(cat);
		});
	}

	sort_db()
	{
		// Shaddow sort of the categorites...
		this.m_source = sort_obj_props(this.m_source);
		
		// Deep sort of the record tables.
		this.categories.forEach( cat => {
			this.m_source[cat] = sort_obj_props(this.m_source[cat]);
			Object.keys(this.m_source[cat]).forEach( key => {
				this.m_source[cat][key] = sanitize_record(this.m_source[cat][key]);
			})
		});
	}

	get_prompts_from_style_prompt(cat, subcat)
	{
		var prompt_record = get_opv(this.style_prompts, cat, null);
		if (prompt_record == null)
			return [];
		
		if (subcat.length == 0)
			return [prompt_record.default_prompt];
		
		var subcats = get_opv(prompt_record, "subcategories", null);
		if (subcats == null || !(subcat in subcats))
		{
			report_results("Unknown subcategory: " + subcat);
			return [prompt_record.default_prompt];
		}

		return [subcats[subcat].default_prompt];
	}

	get_prompts_from_style(style_tag)
	{
		var style_record = get_opv(this.styles, style_tag, null);
		if (style_record == null)
		{
			report_results("Unknown style tag: " + style_tag);
			return style_tag;
		}

		var name = style_record.name; // DO NOT USE KEY, WHICH MAY BE TOO SPECIFIC
		var prompts = get_opv(style_record, "override_prompts", []);
		if (prompts.length == 0)
		{
			prompts = this.get_prompts_from_style_prompt(style_record.category, get_opv(style_record, "subcategory", ""));
		}

		return prompts.map( str => str.replace("*", name));
	}

	ensure_style_prompts()
	{
		var found_cats = {};
		Object.keys(this.styles).forEach( style_key => {
			var style_record = this.styles[style_key];
			var cat_key = get_opv(style_record, "category", null);
			if (cat_key == null)
				return;

			if (!(cat_key in found_cats))
			{
				found_cats[cat_key] = new Object();
				found_cats[cat_key].name = cat_key;
				found_cats[cat_key].subcats = [];
			}

			var subcat_key = get_opv(style_record, "subcategory", null);
			if (subcat_key != null)
			{
				if (!found_cats[cat_key].subcats.includes(subcat_key))
					found_cats[cat_key].subcats.push(subcat_key);
			}
		});

		Object.keys(found_cats).forEach( cat_key => {
			if (!(cat_key in this.style_prompts))
			{
				this.style_prompts[cat_key] = new Object();
				this.style_prompts[cat_key]["name"] = cat_key;
				this.style_prompts[cat_key]["default_prompt"] = "TODO *";
			}

			found_cats[cat_key].subcats.forEach( sub_key => {
				if (!("subcategories" in this.style_prompts[cat_key]))
					this.style_prompts[cat_key]["subcategories"] = new Object();
				
				if (!(sub_key in this.style_prompts[cat_key]["subcategories"]))
				{
					this.style_prompts[cat_key]["subcategories"][sub_key] = new Object();
					this.style_prompts[cat_key]["subcategories"][sub_key]["name"] = sub_key;
					this.style_prompts[cat_key]["subcategories"][sub_key]["default_prompt"] = "TODO *";
				}
			});
		});
	}

	sanitize_db()
	{
		this.generate_desc();
		this.ensure_style_prompts();
		this.sort_db();
	}

	generate_cols_from_category(category)
	{
		var cat_records = this.get_category_records(category);

		var cols = {};
		Object.keys(cat_records).forEach( key => {
			Object.keys(cat_records[key]).forEach( pKey => {
				if (!(pKey in cols))
				{
					var val = cat_records[key][pKey];
					cols[pKey] = get_var_type(val);
				}
			});
		});
		return sort_obj_props(cols, true);
	}

	get_all_subject_names(fav_only)
	{
		var raw_names = Object.keys(this.subjects);
		if (fav_only)
			raw_names = raw_names.filter( name => Object.keys(this.subjects[name]).includes("favorite") && this.subjects[name].favorite == 1);
		return raw_names;
	}

	get_subject_record(name)
	{
		return get_opv(this.subjects, name, null);
	}

	decorate_subject_name_from_record(subject_record)
	{
		var output = "";
		if (Object.keys(subject_record).includes("prefixes"))
			output += subject_record["prefixes"] + " ";
		
		var wrap_brackets = 0;
		if (Object.keys(subject_record).includes("exaggerated"))
			wrap_brackets = parseInt(subject_record["exaggerated"]);

		output += "[".repeat(wrap_brackets) + subject_record["name"] + "]".repeat(wrap_brackets);
		if (Object.keys(subject_record).includes("postfixes"))
			output += ", " + subject_record["postfixes"];
		return output;
	}


	decorate_subject_name(name)
	{
		return this.decorate_subject_name_from_record(this.get_subject_record(name));
	}

	get_record_names_from_category(category, decorate = false)
	{
		var rgNames = Object.keys(this.get_category_records(category));
		var output = "";
		if (category === "subjects" && decorate)
		{
			rgNames.forEach( subject_key => {
				var subject_record = this.subjects[subject_key];
				output += this.decorate_subject_name_from_record(subject_record);
				output += "\n"
			});
			return output;
		}
		else
		{
			return rgNames.join("\n");
		}
	}

	random_subject(fav_only)
	{
		return random_entry(this.get_all_subject_names(fav_only));
	}

	random_prompt(fav_only)
	{
		var style_prompts = this.get_prompts_from_style(random_object_key(this.styles));
		return this.decorate_subject_name(this.random_subject(fav_only)) + ", " + random_entry(style_prompts);
	}
};

var g_database = null;
var g_process_mode = "";

function obj_to_json(obj)
{
	return JSON.stringify(obj, null, "\t");
}

function report_results(success, msg)
{
	var p_result = null;

	p_result = $("#p_" + g_process_mode + "_results");

	p_result.removeClass("success failure");
	p_result.addClass(success ? "success" : "error");
	p_result.text(msg);
}

function get_sel_cat() { return $("#sel_category option").filter(":selected").val(); }
function get_sel_cat_list() { return g_database.get_category_records(get_sel_cat()); }

function refresh_edit_tab()
{
	var sel_cat = get_sel_cat()
	$("#sel_item").empty();
	$("#props").empty();

	var cat_records = g_database.get_category_records(sel_cat);
	if (cat_records == null)
		return;
	
	var item_list = $("#sel_item");
	// item_list.attr("size", obj_prop_count(cat_records));
	Object.keys(cat_records).forEach( key => {
		item_list.append($( '<option value="' + key + '">' + key + '</option>' ));
	});
}


function get_sel_key()
{
	var sel_key = $("#sel_item option").filter(":selected").val();
}

function refresh_edit_props()
{
	var props_div = $("#props");
	props_div.empty();
	
	var sel_key = $("#sel_item option").filter(":selected").val();
	if (sel_key != null && sel_key.length > 0)
	{
		cat_records = get_sel_cat_list();
		if (cat_records == null)
			return;

		sel_obj = cat_records[sel_key];
		if (sel_obj != null)
		{
			var i = 0;
			props = g_database.generate_cols_from_category(get_sel_cat());
			
			Object.keys(props).forEach( prop_key => {
				var change_val = get_prop_change( get_sel_cat(), sel_key, prop_key );
				var val = (change_val == null) ? get_opv(sel_obj, prop_key) : change_val;
				if (Array.isArray(val))
					val = val.join("; ");
				var changed_class = (change_val == null) ? '' : ' prop_changed';
				props_div.append( $( '<div class="prop_row"><label class="prop_label' + changed_class + '" for="txt_prop_' + i + '">' + prop_key + '</label><textarea class="txt_prop' + changed_class + '" id="txt_prop_' + i + '" data-prop="' + prop_key + '" rows="1">' + val + '</textarea></div>') );
			});
		}
	}

	$(".txt_prop").on('change keyup paste', function() {
		var first_edit = (!$(this).hasClass("prop_changed"));
		add_prop_change(get_sel_cat(), get_sel_key(), $(this).attr("data-prop"), $(this).val );
		if (first_edit)
		{
			var label = $("label[for='" + $(this).attr('id') + "']");
				label.addClass("prop_changed");
			$(this).addClass("prop_changed");
		}
	});
}

var g_prop_changes = new Object();

function get_prop_change_item(cat, item_key, ensure = false)
{
	if (!Object.keys(g_prop_changes).includes(cat))
	{
		if (ensure)
			g_prop_changes[cat] = new Object();
		else
			return null;
	}
	
	if (!Object.keys(g_prop_changes[cat]).includes(item_key))
	{
		if (ensure)
			g_prop_changes[cat][item_key] = new Object();
		else
			return null;
	}

	return g_prop_change[cat][item_key];
}

function add_prop_change(cat, item_key, prop_key, new_value)
{
	var item = get_prop_change_item(cat, item_key, true);
	item[prop_key] = new_value;
}

function create_new_item(cat, item_key)
{
	var new_item = get_prop_change_item(cat, item_key, true);
	new_item["name"] = item_key;
	new_item["_new"] = true;
}

function delete_item(cat, item_key)
{
	var del_item = get_prop_change_item(cat, item_key);
	if (del_item != null)
	{
		del_item["_del"] = true;
	}
}

function revert_prop_change(cat, item_key, prop_key)
{
	var item = get_prop_change_item(cat, item_key);
	if (item != null && Object.keys(item).includes(prop_key))
		g_prop_changes[cat][item_key][prop_key] = null;
}

function get_prop_change(cat, item_key, prop_key)
{
	var item = get_prop_change_item(cat, item_key);
	if (item != null && Object.keys(item).includes(prop_key))
		return item[prop_key];
	return null;
}

function abandon_prop_changes()
{
	g_prop_changes = new Object();
}

function commit_prop_changes_to_obj(cat, item_key)
{
	var cat_list = g_database.get_category_records(cat);

	if (!Object.keys(cat_list).includes(item_key))
	{
		cat_list[item_key] = new Object();
	}
	if (Object.keys(g_prop_changes[cat][item_key]).includes("_del"))
	{
		delete cat_list[item_key];
		return;
	}

	var db_item_key = item_key;
	Object.keys(g_prop_changes[cat][item_key]).forEach( prop_key => {
		
		// Ignore special properties
		if (prop_key[0] == '_')
			return;

		if (prop_key === "name")
		{
			var old_key = item_key;
			var new_key = g_prop_changes[cat][item_key][prop_key];
			if (old_key !== new_key)
			{
				// This is a re-name, so we have to remove the old object
				// and re-add it under the new key.
				var oldObj = cat_list[old_key];
				delete cat_list[old_key];
				db_item_key = new_key;
				cat_list[new_key] = oldObj;
			}
		}
		cat_list[db_item_key][prop_key] = g_prop_changes[cat][item_key][prop_key];
	});
}

function commit_prop_changes()
{
	Object.keys(g_prop_changes).forEach( cat => {
		Object.keys(g_prop_changes[cat]).forEach( item_key => {
				commit_prop_changes_to_obj(cat, item_key);
		});
	});
}


function obj_prop_count(obj)
{
	return Object.keys(obj).length;
}

function load_json()
{
	var json  = $("#json_in").val();
	g_database = new PromptDatabase(JSON.parse(json));
	var desc = "JSON Loaded:\n---------\n";
	desc += "Subjects: " + obj_prop_count(g_database.subjects) + " entries.\n";
	desc += "Styles: " + obj_prop_count(g_database.styles) + " entries.\n";
	desc += g_database.random_prompt(false);
	desc += "\n---------\n";
	$("#txt_out").val(desc);
}


function get_record_names_from_category_filter(category, decorate)
{
	var filter = $("#txt_filter").val();
	var fav_only = $("#cb_favorites").is(':checked');
	var rgNames = Object.keys(g_database.get_category_records(category));
	var output = "";
	if (category === "subjects")
	{
		rgNames.forEach( item_key => {
			var subject_record = g_database.subjects[item_key];

			var fAllow = true;
			if (filter != null && filter.length > 0)
			{
				fAllow = Object.keys(subject_record).filter( key => subject_record[key].toString().toLowerCase().includes(filter.toLowerCase()) ).length > 0
			}

			if (fAllow && fav_only && (!Object.keys(subject_record).includes("favorite") || subject_record["favorite"] == 0))
			{
				fAllow = false;
				return;
			}

			if (fAllow)
			{
				output += g_database.decorate_subject_name_from_record(subject_record) + "\n";
			}
		});
		return output;
	}
	else
	{
		return rgNames.join("\n");
	}
}


function get_psv(category)
{
	if (g_database == null)
	{
		report_results(false, "No JSON Loaded!");
	}

	var rg_records = g_database.get_category_records(category);
	var dict_cols = g_database.generate_cols_from_category(category);

	var output = Object.keys(dict_cols).join("|") + "\n";
	Object.keys(rg_records).forEach( record_key => {
		var first = true;
		Object.entries(dict_cols).forEach( entry => {
			const [colName, colType] = entry;
			if (first)
				first = false;
			else
				output += "|"
			if (Object.keys(rg_records[record_key]).includes(colName))
			{
				if (colType == "array")
					output += rg_records[record_key][colName].join(";");
				else
					output += rg_records[record_key][colName];
			}
		});
		output += "\n";
	});

	$("#tool_out").val(output);
	report_results(true, "PSV Output!");
}


document.addEventListener("DOMContentLoaded", function() {
	
	// JQuery UI Inits
	$( function() { $("#tabs").tabs() });

	$("#btn_load_json").click(function() {
		g_process_mode = "load";
		load_json();
	});

	$("#btn_get_styles_psv").click(function() {
		g_process_mode = "tool";
		get_psv("styles");
	});

	$("#btn_get_subjects_psv").click(function() {
		g_process_mode = "tool";
		get_psv("subjects");
	});

	$("#btn_get_subject_names").click(function() {
		g_process_mode = "tool";
		$("#tool_out").val(get_record_names_from_category("subjects", true));
	});

	$("#btn_filter_subject_names").click(function() {
		g_process_mode = "tool";
		$("#tool_out").val(get_record_names_from_category_filter("subjects", true));
	});

	$("#btn_random_prompts").click(function() {
		g_process_mode = "tool";
		var cp = parseInt($("#prompt_count").val());
		var sub_only = $("#cb_subjects_only").is(":checked");
		var fav_only = $("#cb_favorites").is(':checked');
		var extra = $("#random_prompt_postfix").val().trim();
		if (extra.length > 0)
			extra = ", " + extra;
		
		prompts = Array.from({length: cp}, function() {
			if (sub_only)
				return g_database.decorate_subject_name(g_database.random_subject(fav_only)) + extra;
			else
				return g_database.random_prompt(fav_only) + extra;
		});

		out = $("#tool_out").val();
		if (out.length > 0 && !out.endsWith("\n"))
			out += "\n";
		$("#tool_out").val(out + prompts.join("\n") + "\n");
	});

	$("#btn_get_json").click(function() {
		g_process_mode = "tool";
		g_database.sanitize_db();
		$("#tool_out").val(g_database.json);
	});

	$("#btn_clear_tool_outout").click(function() {
		$("#tool_out").val("");
	});

	$("#sel_category").change(function() {
		refresh_edit_tab();
	});

	$("#sel_item").change(function() {
		refresh_edit_props();
	});

	$("#prompt_count_slider").on('input', function() {
		newval = $(this).val();
		if (newval < 1)
			newval = 1;
		$("#prompt_count").val(newval);
	})


});
	</script>
</body>
